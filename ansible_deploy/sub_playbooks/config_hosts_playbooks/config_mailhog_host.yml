---
- name: Deploy the vue frontend component of the app
  hosts: mailhog_servers
  become: yes
  vars:
    mailhog_binary_url: "https://github.com/mailhog/MailHog/releases/download/v1.0.1/MailHog_linux_amd64"
    mailhog_bin_path: "/usr/local/bin/mailhog"
  tasks:
  
  - name: Ensure wget is installed
    apt:
      name: wget
      state: present
  
  - name: Download MailHog binary
    get_url:
      url: "{{ mailhog_binary_url }}"
      dest: "/tmp/MailHog"
      mode: '0755'
      
  - name: Move MailHog binary to /usr/local/bin
    command: mv /tmp/MailHog {{ mailhog_bin_path }}
    args:
      creates: "{{ mailhog_bin_path }}"
      
  - name: Ensure mailhog user exists
    ansible.builtin.user:
      name: mailhog
      system: yes # sets the user as system accounts (usually UID<1000)
      shell: /usr/sbin/nologin # prevents login access
      create_home: no
      
  - name: Create systemd service for MailHog
    copy:
      dest: /etc/systemd/system/mailhog.service
      content: |
          [Unit]
          Description=MailHog service
          After=network.target

          [Service]
          ExecStart={{ mailhog_bin_path }} -smtp-bind-addr "0.0.0.0:1025" -ui-bind-addr "0.0.0.0:8025"
          Restart=always
          User=mailhog

          [Install]
          WantedBy=multi-user.target
      owner: root
      group: root
      mode: '0644'

  - name: Reload systemd daemon
    systemd:
      daemon_reload: yes

  - name: Enable and start MailHog service
    systemd:
      name: mailhog
      state: started
      enabled: yes
  