---
- name: Launch Docker host
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:

    # Gets the current public IP of the localhost
    - name: Get currennt public IP
      ansible.builtin.uri:
        url: https://api.ipify.org
        return_content: yes
      register: my_ip

    # Creates a new key pair and defines the keyout variable with the private key's value
    - name: Create key pair for the instance
      ec2_key:
        name: docker-host-key
      register: keyout

    # Saves the key to a .pem file if the value of the key
    - name: save private key
      copy:
        content: "{{ keyout.key.private_key }}"
        dest: "{{ lookup('env','HOME') }}/.ssh/docker-server-key.pem"
        mode: '0600'
      when: keyout.changed

    # Creates a new sg for ssh and http connection from localhost
    - name: Create the security group of the instance
      amazon.aws.ec2_security_group:
        name: "Docker-sg"
        description: "Security group for the Docker host"
        vpc_id: vpc-0a939c19442ae9cf8
        region: "{{ lookup('env', 'AWS_DEFAULT_REGION') }}"
        rules:

          # access for control_vm
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: "{{ my_ip.content }}/32"
          - proto: tcp
            from_port: 8000
            to_port: 8000
            cidr_ip: "{{ my_ip.content }}/32"

          # access for my browser
          - proto: tcp
            from_port: 8000
            to_port: 8000
            cidr_ip: "85.73.70.239/32"
        
        state: present
      register: security_group

    # Create an EC2 instance
    - name: Launch the Docker host
      amazon.aws.ec2_instance:
        name: "docker_server"
        image_id: ami-020cba7c55df1f615
        key_name: docker-host-key
        instance_type: t2.micro
        exact_count: 1
        region: "{{ lookup('env', 'AWS_DEFAULT_REGION') }}"
        network_interfaces:
          - device_index: 0
            subnet_id: subnet-0e36781135332841e
            groups:
              - "{{ security_group.group_id }}"
            assign_public_ip: true
        wait: yes
        tags:
          Environment: Docker
      register: ec2

    - name: Add the EC2 instance on inventory
      add_host:
        name: "{{ ec2.instances[0].public_ip_address }}"
        groups: 
          - docker_server
        ansible_user: ubuntu
        ansible_ssh_private_key_file: "{{ lookup('env','HOME') }}/.ssh/docker-server-key.pem"
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"


    - name: Wait for SSH connection
      ansible.builtin.wait_for:
        host: "{{ ec2.instances[0].public_ip_address }}"
        port: 22
        timeout: 300
        state: started
      delegate_to: localhost
